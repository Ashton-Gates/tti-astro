---
import axios from 'axios';

let orgs = [];

try {
  const res = await axios.get("https://cms.namel3ss.org/api/trusted-orgs?pagination[limit]=100", {
    headers: {
      Authorization: "Bearer 4ecaeb3b5cacd0cfc224cf19b682d4c24706c9e92895027d0670c574cb41a537c0aca61b3d6fb0f5c0832579813d8b0ece8f8a4e5bcb5b98c08ee478f3634e28620e51b21f85c87edbfd2ecf486d77d3cdb77742875f65e6c40c4d63da4a3efc4745e60679827ee953ee0e67d28da4e32baeb225a551dc06497bb7c8dff1010f"
    }
  });
  orgs = res.data.data.map(entry => entry.attributes || entry); // normalize
} catch (err) {
  console.error("‚ùå Failed to fetch orgs:", err);
}

const regions = [...new Set(orgs.map(o => o.region).filter(Boolean))];
const categories = [...new Set(orgs.flatMap(o => (o.category || '').split(',').map(c => c.trim())).filter(Boolean))];
---

<html lang="en">
  <head>
    <title>Trusted Organizations | Project Ojo</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/src/styles/global.css" />
  </head>
  <body class="bg-gray-100 text-gray-900 font-sans">
    <main class="p-6 max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-6">Find Help</h1>

      <div id="step1" class="mb-6">
        <h2 class="text-xl font-semibold mb-4">üåç Where are you located?</h2>
        <div class="flex flex-wrap gap-2">
          {regions.map(region => (
            <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400 transition" data-region={region}>{region}</button>
          ))}
        </div>
      </div>

      <div id="step2" class="mb-6 hidden">
        <h2 class="text-xl font-semibold mb-4">üìö What type of help are you looking for?</h2>
        <div class="flex flex-wrap gap-2">
          {categories.map(cat => (
            <button type="button" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full focus:outline-none focus:ring-2 focus:ring-green-400 transition" data-category={cat}>{cat}</button>
          ))}
        </div>
      </div>

      <div class="my-4">
        <button id="showAllBtn" class="text-blue-700 border border-blue-700 px-4 py-1 rounded-full text-sm hover:bg-blue-100">Show all organizations</button>
      </div>

      <ul id="orgList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></ul>

      <script type="application/json" id="org-data">
        {JSON.stringify(orgs)}
      </script>

      <script>
        const orgList = document.getElementById("orgList");
        const regionButtons = document.querySelectorAll("[data-region]");
        const categoryButtons = document.querySelectorAll("[data-category]");
        const step1 = document.getElementById("step1");
        const step2 = document.getElementById("step2");

        let selectedRegion = "";
        let selectedCategory = "";
        const allOrgs = JSON.parse(document.getElementById("org-data").textContent);

        function renderOrgs(showAll = false) {
          const filtered = allOrgs.filter(org => {
            if (showAll) return true;
            const regionMatch = selectedRegion && org.region?.trim() === selectedRegion.trim();
            const categoryList = (org.category || "").split(",").map(c => c.trim().toLowerCase());
            const categoryMatch = selectedCategory && categoryList.includes(selectedCategory.trim().toLowerCase());
            return regionMatch && categoryMatch;
          });

          orgList.innerHTML = filtered.length
            ? filtered.map(org => `
              <li class="bg-white p-4 rounded-xl shadow hover:shadow-md transition border">
                <h2 class="text-xl font-semibold mb-2">${org.org_name}</h2>
                <p class="text-sm text-gray-600">${org.region} ‚Äî ${org.category}</p>
                ${org.services_offered ? `<p class="text-sm mb-2">${org.services_offered}</p>` : ""}
                ${org.hotline_or_contact ? `<p class="text-sm text-blue-600"><a href="mailto:${org.hotline_or_contact}">${org.hotline_or_contact}</a></p>` : ""}
              </li>
            `).join("")
            : "<p class='text-gray-500 italic'>No matching organizations found.</p>";
        }

        regionButtons.forEach(btn => {
          btn.addEventListener("click", () => {
            selectedRegion = btn.dataset.region;
            step1.classList.add("hidden");
            step2.classList.remove("hidden");
          });
        });

        categoryButtons.forEach(btn => {
          btn.addEventListener("click", () => {
            selectedCategory = btn.dataset.category;
            step2.classList.add("hidden");
            renderOrgs();
          });
        });

        document.getElementById("showAllBtn")?.addEventListener("click", () => renderOrgs(true));
      </script>
    </main>
  </body>
</html>
